<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $timeout, spUtil, $rootScope, nowAttachmentHandler, $sce, $uibModal) {
	/* widget controller */
	var c = this;
	c.conversation_open = false;

	c.postEntry = function(input) {
		c.server.get({
			action : "insertComment",
			comment : input,
			table : c.data.table,
			sys_id : c.data.sys_id,
			tab: c.data.tab
		}).then(function(response) {
			c.data.journalEntry = '';
		});
	};

	$scope.keyPress = function(event) {
		if (event.keyCode === 13 && !event.shiftKey) {
			$timeout(function() {
				if (c.data.journalEntry)
					c.postEntry(c.data.journalEntry);
			}, 250);
		}
	}

	$scope.$watch("data.sys_id", function() {
		setTimeout(function(){
			$rootScope.$broadcast('prepareAttachments', c.data.table, c.data.sys_id);
		}, 500);
		spUtil.recordWatch($scope, c.data.table, 'sys_id=' + c.data.sys_id, function(event) {
			c.server.get({
				action : "newComment",
				sys_id : c.data.sys_id,
				table : c.data.table
			}).then(function(response) {
				c.data.journalEntry = '';
				c.data.stream = response.data.stream;
				c.data.mergedEntries = response.data.mergedEntries;
				c.data.mergedEntriesAll = c.data.mergedEntries;
				prepareEntries();
			});
		});
	});

	c.showConversation = function(entry){
		//$('#conversation_modal' + c.data.sys_id).modal("show");
		c.conversation_open = true;
		c.showAllModal(entry);
		$timeout(function() {
			scrollToModal('comment_' + entry.id);
		}, 200);
	}

	c.showAllModal = function(entry){
		for(i in c.data.mergedEntriesAll){
			if(entry.id == c.data.mergedEntriesAll[i].id){
				c.data.mergedEntriesAll[i].showingAll = true;
			}
			else{
				c.data.mergedEntriesAll[i].showingAll = false;
			}
		}
	}

	c.hideModal = function(id){
		$(id).modal("hide");
	}
	c.hideConversation = function(){
		c.conversation_open = false;
	}

	$('#ritmDetails').on('hide.bs.modal', function (e) {
		if(c.conversation_open){
			return false;
		}
	});

	openKB = function(kb_id){
		var jsonArticle = {articleID : kb_id};
		$rootScope.$broadcast('openKbModal', jsonArticle, true);
		$('#openKbModal').modal("show");
	}

	if(c.data.mergedEntries){
		prepareEntries();
	}
	function prepareEntries(){
		for(var i in c.data.mergedEntries){
			//if(c.data.mergedEntries[i].has_link){
			var display_value = c.data.mergedEntries[i].display_value + "";
			var value = c.data.mergedEntries[i].value + "";
			do{
				display_value = display_value.replace("&lt;","<");
				display_value = display_value.replace("&gt;", ">");
			}while(display_value.includes("&lt;") || display_value.includes("&gt;"));
			do{
				value = value.replace("&lt;","<");
				value = value.replace("&gt;", ">");
			}while(value.includes("&lt;") || value.includes("&gt;"));

			display_value = $sce.trustAsHtml(display_value);
			value = $sce.trustAsHtml(value);
			c.data.mergedEntries[i].display_value = display_value;
			c.data.mergedEntries[i].value = value;
			//} 

		}
		for(var i in c.data.mergedEntriesAll){
			//if(c.data.mergedEntries[i].has_link){
			var display_value = c.data.mergedEntriesAll[i].display_value + "";
			var value = c.data.mergedEntriesAll[i].value + "";
			do{
				display_value = display_value.replace("&lt;","<");
				display_value = display_value.replace("&gt;", ">");
			}while(display_value.includes("&lt;") || display_value.includes("&gt;"));
			do{
				value = value.replace("&lt;","<");
				value = value.replace("&gt;", ">");
			}while(value.includes("&lt;") || value.includes("&gt;"));

			display_value = $sce.trustAsHtml(display_value);
			value = $sce.trustAsHtml(value);
			c.data.mergedEntriesAll[i].display_value = display_value;
			c.data.mergedEntriesAll[i].value = value;
			//} 
		}
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.content_conversation_all {&#13;
  .conversation_title {&#13;
    text-transform: uppercase;&#13;
    font-size: 14px;&#13;
    font-family: $text-bolder;&#13;
  }&#13;
  .activity_content {&#13;
    max-height: 410px;&#13;
    overflow: auto;&#13;
    margin-bottom: 20px;&#13;
    margin-left: -4px;&#13;
    padding-left: 4px;&#13;
  }&#13;
  .timeline {&#13;
    padding-top: 0;&#13;
  }&#13;
  .timeline:before {&#13;
    top: 8px;&#13;
    border-right: 2px solid $slate-gray;&#13;
    right: 100%;&#13;
    height: calc(100% - 78px);&#13;
    z-index: 1;&#13;
  }&#13;
  .conversation_entries {&#13;
    padding-left: 30px;&#13;
&#13;
    .conversation_mark {&#13;
      width: 10px;&#13;
      height: 10px;&#13;
      border-radius: 5px;&#13;
      background-color: white;&#13;
      border: 1px solid $deep-sky-blue;&#13;
      position: absolute;&#13;
      top: 5px;&#13;
      left: -4px;&#13;
      z-index: 3;&#13;
    }&#13;
    .hide_timeline_property{&#13;
      background: white;&#13;
      height: 18px;&#13;
      width: 10px;&#13;
      z-index: 4;&#13;
      position: absolute;&#13;
      left: -4px;&#13;
      bottom: 0;&#13;
    }&#13;
    .new_radio_mark{&#13;
      width: 10px;&#13;
      height: 10px;&#13;
      border-radius: 5px;&#13;
      background-color: white;&#13;
      border: 1px solid $deep-sky-blue;&#13;
      position: absolute;&#13;
      top: 5px;&#13;
      left: -4px;&#13;
      z-index: 5;&#13;
    }&#13;
  }&#13;
  .conversation_entries:last-child {&#13;
    .conversation_action {&#13;
      text-decoration: underline;&#13;
    }&#13;
  }&#13;
  .conversation_entries:first-child {&#13;
    .conversation_mark {&#13;
      background-color: $deep-sky-blue;&#13;
    }&#13;
  }&#13;
  .conversation_fixed {&#13;
    position: sticky;&#13;
    bottom: -40px;&#13;
    z-index: 4;&#13;
    padding-bottom: 23px;&#13;
&#13;
    .conversation_fixed_text {&#13;
      background-color: white;&#13;
      height: 40px;&#13;
    }&#13;
  }&#13;
  .content_conversation_dynamic {&#13;
    height: 260px;&#13;
    overflow: auto;&#13;
  }&#13;
&#13;
  .conversation_action {&#13;
    font-size: 12px;&#13;
    color: $deep-sky-blue;&#13;
    font-family: $text-bold;&#13;
  }&#13;
  .simple_conversation_title{&#13;
    font-size: 12px;&#13;
    color: $deep-sky-blue;&#13;
    font-family: $text-bold;&#13;
  }&#13;
  .conversation_description {&#13;
    font-size: 12px;&#13;
    color: $slate-gray;&#13;
  }&#13;
  .conversation_date {&#13;
    font-size: 10px;&#13;
  }&#13;
&#13;
  .conversation_form {&#13;
    margin-left: 30px;&#13;
&#13;
    .conversation_user {&#13;
      margin-left: -46px;&#13;
&#13;
      img {&#13;
        width: 36px;&#13;
        height: 36px;&#13;
      }&#13;
      .user_name {&#13;
        margin-left: 7px;&#13;
        font-family: $text-bold;&#13;
      }&#13;
    }&#13;
&#13;
    .submit_name {&#13;
      text-transform: uppercase;&#13;
      margin-left: 8px;&#13;
      color: $deep-sky-blue;&#13;
      font-size: 18px;&#13;
      font-family: $text-bold;&#13;
    }&#13;
&#13;
    textarea {&#13;
      min-height: 80px;&#13;
      margin-bottom: 20px;&#13;
      border: 2px solid $deep-sky-blue;&#13;
    }&#13;
  }&#13;
  .view_more_color{&#13;
    font-size: 12px;&#13;
    color: $deep-sky-blue;&#13;
    font-family: $text-bold;&#13;
  }&#13;
}&#13;
&#13;
.content_conversation {&#13;
  padding-bottom: 50px;&#13;
&#13;
  .number_title {&#13;
    .ticket_number {&#13;
      font-size: 12px;&#13;
    }&#13;
    .ticket_title {&#13;
      font-size: 16px;&#13;
      text-decoration: underline;&#13;
      font-family: $text-bold;&#13;
    }&#13;
  }&#13;
&#13;
  .avatar_list {&#13;
    padding-left: 15px;&#13;
  }&#13;
  .avatar-custom-size {&#13;
    float: left;&#13;
  }&#13;
&#13;
  .avatar-container {&#13;
    cursor: default;&#13;
  }&#13;
  .avatar {&#13;
    height: 40px !important;&#13;
    width: 40px !important;&#13;
    margin-top: -10px;&#13;
  }&#13;
  .avatar-container.avatar-large .avatar.soloAvatar .sub-avatar{&#13;
    background: white;&#13;
    border: solid 2px $deep-sky-blue;&#13;
    border-radius: 50%;&#13;
    line-height: 4rem;&#13;
&#13;
    span {&#13;
      font-family: $text-bold;&#13;
      color: $deep-sky-blue;&#13;
    }&#13;
  }&#13;
  .all-avatar {&#13;
    .avatar-container .avatar.soloAvatar {&#13;
      .sub-avatar {&#13;
        color: white !important;&#13;
        background: white !important;&#13;
        border: solid 2px $deep-sky-blue !important;&#13;
        border-radius: 50% !important;&#13;
      }&#13;
    }&#13;
  }&#13;
&#13;
  .history-name-size {&#13;
    font-family: $text-bold;&#13;
  }&#13;
&#13;
&#13;
  .time-text {&#13;
    font-size: 10px;&#13;
    margin-left: 49px;&#13;
    margin-top: -8px;&#13;
  }&#13;
&#13;
  .message_user {&#13;
    img {&#13;
      height: 40px;&#13;
    }&#13;
    .user_name {&#13;
      font-family: $text-bold;&#13;
      margin-left: 5px;&#13;
    }&#13;
  }&#13;
&#13;
  .form-control {&#13;
    overflow-x: hidden !important;&#13;
    overflow-wrap: break-word !important;&#13;
    height: 120px !important;&#13;
    width: 400px;&#13;
    border: solid 2px #00BFFF;&#13;
    margin: 0 66px !important;&#13;
  }&#13;
&#13;
  .conversation_form {&#13;
&#13;
    input[type="image"] {&#13;
      width: 50px;&#13;
      height: 50px;&#13;
      margin-right: 65px;&#13;
      margin-top: 10px;&#13;
    }&#13;
  }&#13;
&#13;
  .attach_button {&#13;
    float: left;&#13;
    margin-left: 42px;&#13;
    margin-right: -18px;&#13;
    transform: scaleX(-1);&#13;
&#13;
    .glyphicon-paperclip {&#13;
      color: $deep-sky-blue;&#13;
      transform: rotate(135deg);&#13;
      font-size: 22px;&#13;
    }&#13;
  }&#13;
  .attach_title {&#13;
    margin-left: 5px;&#13;
    margin-top: -40px;&#13;
    color: $deep-sky-blue;&#13;
    font-family: $text-bold;&#13;
    text-transform: uppercase;&#13;
  }&#13;
}&#13;
&#13;
.panel-title {&#13;
  display: inline;&#13;
}&#13;
&#13;
.panel-title-container {&#13;
  display: flex;&#13;
  justify-content: space-between;&#13;
  align-items: center;&#13;
}&#13;
&#13;
.panel-title-icons {&#13;
&#13;
  ul {&#13;
    display: flex;&#13;
    align-items: center;&#13;
    padding: 0;&#13;
    margin: 0;&#13;
  }&#13;
  li {&#13;
    padding: 0;&#13;
    margin: 0;&#13;
&#13;
    .panel-button {&#13;
      display: flex;&#13;
      align-items: center;&#13;
      margin: 0 0 0 15px;&#13;
      line-height: initial;&#13;
&#13;
      &amp;:hover, &amp;:focus {&#13;
        text-decoration: none;&#13;
      }&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
&#13;
.timeline-heading test {&#13;
  float:right;&#13;
}&#13;
&#13;
.timeline-body &gt; p {&#13;
  white-space: pre-wrap;&#13;
  overflow-x: hidden;&#13;
}&#13;
&#13;
.timeline-body ul &gt; li {&#13;
  float: none;&#13;
}&#13;
&#13;
.no-resize {&#13;
  resize: none;&#13;
}&#13;
&#13;
.journal-field-indicator {&#13;
  width: 5px;&#13;
  left: 5px;&#13;
  top: 5px;&#13;
  bottom: 5px;&#13;
  z-index: 3;&#13;
}&#13;
&#13;
.panel-heading {&#13;
  word-wrap: break-word;&#13;
}&#13;
&#13;
ul {&#13;
  list-style: none;&#13;
}&#13;
&#13;
.overflow-hidden {&#13;
  overflow: hidden;&#13;
}&#13;
&#13;
.timeline-badge-wrap {&#13;
  margin: auto;&#13;
  max-width: 115px;&#13;
}&#13;
&#13;
.timeline-badge.success {&#13;
  background-color: $success;&#13;
}&#13;
&#13;
.timeline-badge {&#13;
  position: relative;&#13;
  left:25%;&#13;
  width:50%;&#13;
  padding-bottom:50%;&#13;
  border-radius:50%;&#13;
}&#13;
&#13;
.timeline-badge span {&#13;
  top:50%;&#13;
  left: 50%;&#13;
  transform: translate(-50%, -50%);&#13;
  font-size:13px;&#13;
  color: #fff;&#13;
}&#13;
&#13;
.journal-type {&#13;
  display: inline-flex;&#13;
  display: -ms-inline-flexbox;&#13;
  flex-wrap: wrap;&#13;
  -webkit-justify-content: flex-end;&#13;
}&#13;
&#13;
.fa-circle {&#13;
  font-size: 4px;&#13;
  padding: 7px;&#13;
}&#13;
&#13;
@media (max-width: 768px) {&#13;
  .timeline-badge-wrap {&#13;
    margin: 0;&#13;
  }&#13;
  .timeline-badge {&#13;
    left: 10%;&#13;
  }&#13;
}&#13;
&#13;
.translation-font {&#13;
  font-size: 12px;&#13;
}&#13;
&#13;
.translate-link {&#13;
  cursor: pointer;&#13;
  @extend .translation-font;&#13;
}&#13;
&#13;
.translation-credits {&#13;
  font-style: italic;&#13;
}&#13;
&#13;
.translation-message {&#13;
  padding-top: 10px;&#13;
  font-size: 14px;&#13;
  white-space: pre-wrap;&#13;
}&#13;
&#13;
.toggle-link-show {&#13;
  display: none;&#13;
}&#13;
&#13;
.translation-credits {&#13;
  font-style: italic;&#13;
}&#13;
&#13;
.translation-icon {&#13;
  width: 12px;&#13;
  height: 12px;&#13;
  padding-right: 4px;&#13;
  @extend .translation-font;&#13;
}&#13;
&#13;
.translation-container {&#13;
  border: 1px solid $well-border;&#13;
  border-radius: 3px;&#13;
  background-color: $well-bg;&#13;
  padding: 10px;&#13;
  color: $text-color;&#13;
  margin-top: 10px;&#13;
  @extend .translation-font;&#13;
}&#13;
&#13;
.translation-delimiter {&#13;
  padding: 7px;&#13;
  @extend .translation-font;&#13;
}&#13;
&#13;
.translate-wrap {&#13;
  white-space: nowrap;&#13;
}&#13;
&#13;
//Changed, not OOTB&#13;
.white-circle{&#13;
  height: 40px !important;&#13;
  width: 40px !important;&#13;
  line-height: 4.8rem;&#13;
  background: white;&#13;
  border: solid 2px $deep-sky-blue;&#13;
  border-radius: 50%;&#13;
  left: 25px !important;&#13;
}&#13;
&#13;
.request-history-title {&#13;
  color: #708090;&#13;
  font-family: $text-bold;&#13;
  font-size: 24px;&#13;
}&#13;
&#13;
.title-info {&#13;
  color: $deep-sky-blue;&#13;
  font-family: $text-bold;&#13;
  font-size: 16px;&#13;
}&#13;
&#13;
.modal-body .wrapper-xl {&#13;
  padding: 0 !important;&#13;
}&#13;
.modal-body{&#13;
  border: 0 20px solid white;&#13;
  padding: 40px 50px !important;&#13;
  .wrapper-xl {&#13;
    margin-right: -20px;&#13;
  }&#13;
  button {&#13;
    z-index: 5;&#13;
    position: absolute;&#13;
    right: -1px;&#13;
    top: -8px;&#13;
    font-size: 32px;&#13;
    font-family: $text-light;&#13;
  }&#13;
  .title_property{&#13;
    font-size: 32px;&#13;
    text-transform: capitalize;&#13;
  }&#13;
  .turn_bold{&#13;
    font-weight: bold;&#13;
    margin-top: 20px;&#13;
  }&#13;
  .color_change{&#13;
    color: $deep-sky-blue;&#13;
  }&#13;
&#13;
  .activity_content {&#13;
    height: 350px;&#13;
  }&#13;
}&#13;
&#13;
/* Template Notifications */&#13;
.content_notifications {&#13;
  .content_conversation {&#13;
    .attach_button {&#13;
      margin-left: 60px;&#13;
    }&#13;
    .attach_title {&#13;
      margin-top: 20px;&#13;
    }&#13;
    .submit_button {&#13;
      position: absolute;&#13;
      left: 360px;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
/* TOOLTIPS */&#13;
.conversation_action:hover {&#13;
  .tooltip {&#13;
    visibility: visible;&#13;
    opacity: 1;&#13;
  }&#13;
}&#13;
.tooltip_right {&#13;
  top: -1px;&#13;
  left: 170px;&#13;
}&#13;
&#13;
//ATTACHMENT WIDGET&#13;
.content_attach {&#13;
  display: flex;&#13;
  margin-left: 45px;&#13;
&#13;
  .attach_left {&#13;
    width: 47%;&#13;
&#13;
    img {&#13;
      width: 250px;&#13;
      height: 140px;&#13;
      margin-bottom: 10px;&#13;
    }&#13;
    .button_attach {&#13;
      margin-left: -27px;&#13;
&#13;
      .panel-button {&#13;
        float: none;&#13;
      }&#13;
      .btn-link {&#13;
        transform: scaleX(-1);&#13;
&#13;
        .glyphicon-paperclip {&#13;
          color: $deep-sky-blue;&#13;
          transform: rotate(135deg);&#13;
          font-size: 18px;&#13;
        }&#13;
      }&#13;
    }&#13;
    .attach_text {&#13;
      text-transform: uppercase;&#13;
      color: $deep-sky-blue;&#13;
      font-family: $text-bold;&#13;
      font-size: 12px;&#13;
    }&#13;
  }&#13;
&#13;
  .attach_right {&#13;
    width: 53%;&#13;
&#13;
    .attachment_list {&#13;
      .list-group-item {&#13;
        border: 0;&#13;
      }&#13;
      .view-attachment, time {&#13;
        display: none;&#13;
      }&#13;
      .tools {&#13;
        margin-top: -25px;&#13;
      }&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.conversation_fixed_text {&#13;
  .fixed_title { &#13;
    cursor: pointer;&#13;
    transition: .4s ease-in-out;&#13;
    padding-top: 8px;&#13;
    margin-top: -8px;&#13;
  }&#13;
  &amp;:hover {&#13;
    .fixed_title {&#13;
      transition: .2s ease-in-out;&#13;
      transform: translateX(-8px);&#13;
      -webkit-transform: translateX(-8px);&#13;
      -ms-transform: translateX(-8px);&#13;
      -moz-transform: translateX(-8px);&#13;
      -o-transform: translateX(-8px);&#13;
    }&#13;
  }&#13;
}&#13;
.buttons {&#13;
  transition: .4s ease-in-out;&#13;
  &amp;:hover {&#13;
    transition: .2s ease-in-out;&#13;
    transform: scale(1.02);&#13;
    -webkit-transform: scale(1.02);&#13;
    -ms-transform: scale(1.02);&#13;
    -moz-transform: scale(1.02);&#13;
    -o-transform: scale(1.02);&#13;
  }&#13;
}&#13;
.button_size{&#13;
  img{&#13;
    width: 50px;&#13;
    height: 50px;&#13;
  }&#13;
}&#13;
&#13;
.bg_content_feedback {&#13;
  position: fixed;&#13;
  top: -100vh;&#13;
  left: -100vw;&#13;
  width: 200vw;&#13;
  height: 200vh;&#13;
  z-index: 2000;&#13;
  background: rgba(0,0,0,.5);&#13;
  border: 1px solid #7e7e7e;&#13;
  cursor: default;&#13;
}&#13;
&#13;
.content_feedback_ {&#13;
  position: fixed;&#13;
  top: 30px;&#13;
  left: calc(50% - 400px);&#13;
  z-index: 2001;&#13;
}&#13;
.content_feedback {&#13;
  width: 800px;&#13;
  height: 450px;&#13;
  padding: 15px;&#13;
  background: white;&#13;
  text-align: left;&#13;
  position: relative;&#13;
&#13;
  .wrapper-xl {&#13;
    padding: 10px 50px 0 20px !important;&#13;
  }&#13;
&#13;
  .close_feedback {&#13;
    position: absolute;&#13;
    top: 30px;&#13;
    right: 30px;&#13;
    font-size: 32px;&#13;
    font-family: $text-light;&#13;
  }&#13;
  .feedback_title {&#13;
    font-size: 24px;&#13;
    color: $dodger-blue;&#13;
    margin-bottom: 20px;&#13;
  }&#13;
  .send_message {&#13;
    color: $coral;&#13;
    margin-bottom: 15px;&#13;
  }&#13;
  .notification_feedback {&#13;
    color: $coral;&#13;
  }&#13;
  .feedback_send {&#13;
    display: flex;&#13;
    justify-content: flex-end;&#13;
    margin-top: 20px;&#13;
&#13;
    img {width: 50px;}&#13;
  }&#13;
}&#13;
&#13;
.detail_ticket_close {&#13;
  transition: .2s ease-in-out;&#13;
  top: 15px !important;&#13;
  right: 23px !important;&#13;
&#13;
  &amp;:hover {&#13;
    transition: .2s ease-in-out;&#13;
    opacity: .5;&#13;
  }&#13;
}&#13;
&#13;
.dynamic_color_category2 {&#13;
  .conversation_entries:first-child {&#13;
    .conversation_action {&#13;
      text-decoration: underline;&#13;
      color: $dark-orchid !important;&#13;
    }&#13;
  }&#13;
  .new_radio_mark, .conversation_mark{&#13;
    border: 1px solid $dark-orchid !important;&#13;
  }&#13;
  .conversation_entries:last-child {&#13;
    .conversation_mark {&#13;
      background-color: $dark-orchid !important;&#13;
    }&#13;
  }&#13;
  .conversation_form textarea {&#13;
    border: 2px solid $dark-orchid !important;&#13;
  }&#13;
  .submit_name, .glyphicon-paperclip, .attach_text {&#13;
    color: $dark-orchid !important;&#13;
  }&#13;
&#13;
  .modal {&#13;
    .color_change {&#13;
      color: $globo-purple !important;&#13;
    }&#13;
  }&#13;
&#13;
  .view_more_color, .conversation_action, .simple_conversation_title, strong, .file-name a {&#13;
    color: $globo-purple !important;&#13;
  }&#13;
}&#13;
.teste{&#13;
  padding-left: 2em;&#13;
}&#13;
&#13;
@media only screen and (min-width: 768px) {&#13;
  .content_conversation_all {&#13;
    .forecast_field {&#13;
      display: none;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.modal_article{&#13;
  .modal-body {&#13;
    overflow: auto !important;&#13;
  }&#13;
}&#13;
&#13;
@media only screen and (max-width: 768px) {&#13;
&#13;
  .content_conversation_all {&#13;
    .timeline:before {&#13;
      left: 0 !important;&#13;
    }&#13;
    .content_feedback_{&#13;
      left: 10px;&#13;
      right: 10px;&#13;
&#13;
      .content_feedback {&#13;
        width: 100%;&#13;
      }&#13;
    }&#13;
  }&#13;
&#13;
  .modal-content {&#13;
    height: 350px;&#13;
    overflow: auto;&#13;
&#13;
    .modal-body {&#13;
      padding: 20px !important;&#13;
    }&#13;
  }&#13;
&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>gservice_custom_conversation</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>GService Custom Conversation</name>
        <option_schema>[{"hint":"Enter key behavior is specified by system property (glide.service_portal.comment.enter_adds_newline) unless overridden here","name":"enter_key_behavior","section":"Behavior","default_value":"System property","label":"Enter key behavior","type":"choice","choices":[{"label":"System property","value":"System property"},{"label":"Submit","value":"Submit"},{"label":"New line","value":"New line"}]},{"hint":"What is the table of the record?","name":"table","section":"Data","label":"Table","type":"string"},{"hint":"What is the sys_id of the record?","name":"sys_id","section":"Data","label":"Sys_ID","type":"string"},{"hint":"Placeholder text shows selected journal field","name":"use_dynamic_placeholder","section":"Behavior","label":"Use dynamic placeholder","type":"boolean"},{"hint":"Message to show when record has no readable journal field","name":"no_readable_journal_field_message","default_value":"","section":"Presentation","label":"No readable journal field message","type":"string"},{"hint":"Get the template based on the tab","name":"tab","section":"Behavior","label":"Tab Template","type":"string"},{"name":"item_status","section":"Behavior","label":"Item Status","type":"string"},{"hint":"Used to allow the user to add new comments or attachments","name":"hide_new_comments","section":"Behavior","default_value":"","label":"Hide new comments","type":"boolean"},{"hint":"Check this to hide the title","name":"hide_title","section":"Presentation","label":"Hide Title","type":"boolean"},{"name":"color_class","section":"Presentation","label":"Color Class","type":"string"},{"name":"bd_color_class","section":"Presentation","label":"BD Color Class","type":"string"},{"name":"comment_image","section":"Presentation","label":"Comment Image","type":"string"},{"name":"send_image","section":"Presentation","label":"Send Image","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */
	data.hide = false;
	var localInput = input;

	var portalUtils = new global.OCLPortalUtils();
	//Used to get the current user sys_id
	data.gservice_ticket_attachment = [];
	data.showAll = gs.getMessage("GService View More").toLowerCase();
	data.showLess = gs.getMessage("GService See Less").toLowerCase();
	data.hide_new_comments = options.hide_new_comments || false;
	data.hide_title = options.hide_title || false;
	data.moreDetails = false;
	data.color_class = options.color_class || "color_category1_old";
	data.bd_color_class = options.bd_color_class || "bdcolor_category1_old";
	data.send_image = options.send_image || "gservice_dashboard_submit.png";
	data.comment_image = options.comment_image || "gservice_message.png";

	data.article_widget_options = {"broadcast_name": "openKbModal"};
	data.articleWidget = $sp.getWidget("gservice_knowledge_article_content", data.article_widget_options);
	data.helpfulWidget = $sp.getWidget("gservice_knowledge_article_helpful_v2");

	data.motoboy_spot_widget = true;
	data.exception = true;
	if(!localInput){
		data.clear = true;
		data.mergedEntries = [];
		var userID = gs.getUser().getID();
		data.user_id = userID;
		data.username = gs.getUserDisplayName();
		data.statusEntries = [];
		data.sys_id = options.sys_id;
		data.table = options.table;
		
		if(data.table != 'sn_compliance_policy'){
			data.hist = gs.getMessage('GService Conversation Request History');
		}else{
			data.hist = gs.getMessage('GService Conversation Request History IRM');
		}

		var grItem = portalUtils.getRecord(data.table, data.sys_id);

		var created_on = grItem.getDisplayValue('sys_created_on');
		created_on = created_on.split(' ');
		data.createdDate = created_on[0].replace(/-/g, "/");
		data.createdTime = created_on[1];

		//data.stream = $sp.getStream(data.table, data.sys_id);
		data.stream = portalUtils.getStream(data.table, data.sys_id);
		var entries = data.stream.entries;
		var statusEntries = portalUtils.getStateChange(data.sys_id, data.table);
		var mergedEntries = portalUtils.joinEntries(entries, statusEntries);

		data.mergedEntries = portalUtils.sortDateTime(mergedEntries, "sys_created_on_adjusted", -1);
		data.mergedEntriesAll = data.mergedEntries;

		for(var i in data.mergedEntries){
			var value = data.mergedEntries[i].display_value;
			if(value){
				if(value.includes("sys_kb_id") && value.includes("href")){
					var kb_id = value.split("sys_kb_id")[1];
					kb_id = kb_id.split("=")[1];
					kb_id = kb_id.split('"')[0];
					var secondString = value.split(' href="');
					var thirdString = secondString[1].split('"')[1];
					var lastString = secondString[0] + ' onclick="openKB(' + "'" + kb_id + "'"  + ')"' + thirdString;
					data.mergedEntries[i].display_value = lastString;
					data.mergedEntries[i].value = lastString;
					data.mergedEntries[i].has_link = true;
				}
				else{
					data.mergedEntries[i].has_link = false;
				}
			}
		}

		data.gservice_ticket_attachment = $sp.getWidget('gservice_ticket_attachments');
		var grVariables = new GlideRecord(data.table);
		grVariables.get(data.sys_id);

		switch(data.table){
			case "sc_req_item":
			case "u_question":
			case "incident":
			case "sn_si_incident":
				data.variables = portalUtils.getVariablesForTask(grVariables, true);
				break;

			case "change_request":
				var fields = gs.getProperty('gservice_modal_change_fields');
				data.variables = $sp.getFields(grVariables, fields);
				break;

			case "wm_order":
				var wmFields = gs.getProperty('gservice_modal_wm_fields');
				data.variables = $sp.getFields(grVariables, wmFields);
				break;

			default:
				data.variables = portalUtils.getVariablesForTask(grVariables, true);
				break;

		}

		data.ticketInfo = portalUtils.getTicketInfo(data.table, data.sys_id);

	}
	else{
		switch(localInput.action){
			case "insertComment":
				var grTask = portalUtils.getRecord(localInput.table, localInput.sys_id);

				if(localInput.table != 'sn_compliance_policy'){
					grTask.comments = localInput.comment;
				}else{
					grTask.u_comments = localInput.comment;
				}

				grTask.update();
				break;
			case "newComment":
				data.stream = portalUtils.getStream(localInput.table, localInput.sys_id);
				data.mergedEntries = data.stream.entries;
				data.statusEntries = portalUtils.getStateChange(localInput.sys_id, localInput.table);
				var mergedEntries = portalUtils.joinEntries(data.mergedEntries, data.statusEntries);
				data.mergedEntries = portalUtils.sortDateTime(mergedEntries, "sys_created_on_adjusted", -1);
				break;
		}
	}


	// DETASK0001878 remove attachment for MotoboySpot Integration
	var grItem = portalUtils.getRecord(options.table, options.sys_id);
	if(options.table == 'x_gmeps_csc_seguranca') {
		var service2 = grItem.getValue("service") + '';
		var noAttachmentServices2 = gs.getProperty("x_gmeps_itsm_servi.except_seguranca_item");
		if(service2 === noAttachmentServices2)
		data.exception = false;
	}
	if(options.table == "x_gmeps_csc_transportes_frota"){
		var service = grItem.getValue("service") + '';
		var noAttachmentServices = gs.getProperty("no_need_attachment_services");
		if(service === 'undefined') {
			data.motoboy_spot_widget = false;
		}
		if(noAttachmentServices.indexOf(service) > -1){
			var site = grItem.variable_pool.site.getDisplayValue();
			if(site == "BSB" || site == "REC") data.motoboy_spot_widget = true;
			else data.motoboy_spot_widget = false;
		}
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>organize.henrique</sys_created_by>
        <sys_created_on>2020-06-02 15:30:08</sys_created_on>
        <sys_id>4521b25bdb491c905c1163901496193f</sys_id>
        <sys_mod_count>645</sys_mod_count>
        <sys_name>GService Custom Conversation</sys_name>
        <sys_package display_value="ITSM Service Portal" source="x_gmeps_itsm_servi">334ae627dbc85c105c1163901496192f</sys_package>
        <sys_policy/>
        <sys_scope display_value="ITSM Service Portal">334ae627dbc85c105c1163901496192f</sys_scope>
        <sys_update_name>sp_widget_4521b25bdb491c905c1163901496193f</sys_update_name>
        <sys_updated_by>tfesilva</sys_updated_by>
        <sys_updated_on>2022-03-22 15:55:15</sys_updated_on>
        <template><![CDATA[<div class="content_conversation_all dynamic_{{data.color_class}}">
  <div ng-if="data.hide_title == false" class="conversation_title">{{data.hist}}</div>
  
  <div>
    <div class="panel-body">
      <div class="activity_content">
        <ul role="list" class="timeline" aria-label="${Ticket history}">
          <li class="conversation_entries conversation_dynamic" ng-if="data.mergedEntries.length > 0" ng-repeat="e in data.mergedEntries">
            <div class="conversation_mark"></div>
            <div ng-style="{'border-color': getFieldColor(e.element)}">
              <div class="conversation_action {{data.color_class}}">{{e.createdDate}} {{e.createdTime}} - {{e.name}}</div>
              <div class="conversation_description">{{e.field_label}}</div>
              <div>
                <div class="conversation_description" ng-if="(e.element != '
                                                             ment')" ng-bind-html="e.display_value"><span ng-if="e.showAll">...</span></div>
                
                <div ng-if="(e.element == 'attachment')">
                  <a ng-if="(e.attachment.state == 'available')" target="_blank" href="/sys_attachment.do?view=true&sys_id={{e.attachment.sys_id}}" title="${View}">
                    <img ng-if="e.attachment.thumbnail_path" alt="" ng-src="/{{e.attachment.path}}?t=medium" class="img-responsive"/>
                  </a>
                  <a ng-if="(e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally')" ng-click="scanAttachment(e.attachment)" href="javascript:void(0)" title="${View}">
                    <img ng-if="e.attachment.thumbnail_path" alt="" ng-src="/{{::e.attachment.path}}?t=medium" class="img-responsive"/>
                  </a>
                  <div>
                    <div ng-if="(e.attachment.state == 'available')">
                      <a href="/sys_attachment.do?sys_id={{e.attachment.sys_id}}" target="_blank" title="{{dataViewMsg}}"><strong>{{e.attachment.file_name}}</strong></a><br/>
                      {{e.attachment.size}}
                    </div>
                    <div ng-if="(e.attachment.state == 'not_available')">
                      <span title="{{dataViewMsg}}" class="not_available">{{e.attachment.file_name}}</span><br/>
                      <span class="error">{{data.scanFailedMsg}}</span>
                    </div>
                    <div ng-if="(e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally')">
                      <a href="javascript:void(0)" ng-click="scanAttachment(e.attachment)" title="{{dataViewMsg}}"><strong>{{e.attachment.file_name}}</strong></a><br/>
                      {{e.attachment.size}}
                    </div>
                  </div> 
                </div> 
              </div>
              <div ng-if="e.showTranslation" class="translation-container">
                <div ng-if="e.isTranslationInProgress">
                  <i class="translation-icon icon-translation"></i>
                  <span aria-live="polite">{{data.translation.translationProgressMsg}}</span>
                </div>
                <div ng-if="e.isTranslationSuccess">
                  <i class="translation-icon icon-translation"></i>
                  <a class="translate-link" role="button" href="javascript:void(0)" ng-click="toggleTranslation(e)">{{e.toggleMsg}}</a>
                  <span class="translation-credits">{{e.credits}}</span>
                  <div ng-if="e.showDetails" class="translation-message" ng-bind-html="e.translatedText">
                  </div>
                </div>
                <div ng-if="e.isTranslationError">
                  <i class="translation-icon icon-translation"></i>
                  {{e.translatedText}}
                  <a ng-if="e.tryAgain" role="button" href="javascript:void(0)" class="translate-link" ng-click="translateText(e, true)">{{data.translation.tryAgainMsg}}</a>
                </div>
              </div>
            </div>
            <div ng-if="e.showAll" ng-click="c.showConversation(e)" class="view_more_color">{{data.showAll}}</div>
            <!--<div class="conversation_date">{{e.createdDate}}		{{e.createdTime}}</div>-->
          </li>
          <li class="conversation_entries conversation_fixed" role="listitem" aria-label="{{data.stream.user_full_name}}">
            <div class="conversation_mark"></div><span class="hide_timeline_property"></span><span class="new_radio_mark"></span>
            <div class="conversation_fixed_text">
              <div ng-if="data.table != 'sc_request' && !data.hide_title" class="conversation_action" data-toggle="modal" data-target="#moreDetails{{data.sys_id}}">
                <div class="fixed_title {{data.color_class}}">{{data.createdDate}} {{data.createdTime}} - ${Abertura da Solicitação}</div>
                <span class="tooltip tooltip_right">
                  <div class="tooltip_arrow arrow_left"></div>
                  <div class="tooltip_text">${See summary}</div>
                </span>
              </div>
              <div ng-if="data.table == 'sc_request' || data.hide_title">
                <div class="simple_conversation_title">{{data.createdDate}} {{data.createdTime}} - ${Abertura da Solicitação}</div>
              </div>
              <!--<div class="conversation_date">{{data.createdDate}}		{{data.createdTime}}</div>-->
            </div>
          </li>
        </ul>
      </div>

      <div class="conversation_form" ng-if="!data.hide_new_comments && data.motoboy_spot_widget && data.exception">
        <form ng-if="data.item_status != 'resolved'" ng-submit="c.postEntry(data.journalEntry)" id="sand">
          <div class="conversation_user">
            <img src="{{data.comment_image}}"/>
            <span class="user_name">{{data.username}}</span>
          </div>
          <div>
            <textarea ng-keypress="keyPress($event)" sn-resize-height="trim" rows="1" id="post-input" class="form-control no-resize overflow-hidden" ng-model='data.journalEntry' ng-model-options='{debounce: 250}' ng-attr-placeholder="{{getPlaceholder()}}" aria-label="{{getPlaceholder()}}" autocomplete="off" ng-change="userTyping(data.journalEntry)"/>
            <span class="journal-field-indicator" ng-style="({'background-color': data.useSecondaryJournalField ? data.secondaryJournalField.color : data.primaryJournalField.color})"></span>
          </div>
          <div class="buttons button_size" ng-click="c.postEntry(data.journalEntry)">
            <img src="{{data.send_image}}"/>
            <span class="submit_name">Enviar</span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div ng-if="!data.hide_new_comments && data.motoboy_spot_widget && data.exception">
    <widget id="gservice_ticket_attachments"></widget>  
  </div> 

  <div class="modal fade modal_article" id="moreDetails{{data.sys_id}}" tabindex="-1" role="dialog" aria-labelledby="articleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <button type="button" class="close detail_ticket_close" ng-click="c.hideModal('#moreDetails' + c.data.sys_id)" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div class="content_modal">
            <span class="turn_bold color_change title_property">${Solicitação} ${#}{{data.ticketInfo.ticketNumber}}</span>
            <div class="turn_bold color_change">${Data de Abertura}: {{data.ticketInfo.openedAt}}</div>
            <div><span class="turn_bold">${Resumo da solicitação}: </span>{{data.ticketInfo.summary}}</div>
            <div class="turn_bold color_change">${Detalhes da solicitação}:</div>
            <div ng-repeat="variable in data.variables">
              <div ng-if="!variable.multi_row && variable.visible_summary">
                <span class="turn_bold">{{variable.label}} : </span><span>{{variable.display_value}}</span>
              </div>
              <div ng-if="variable.multi_row">
                <span class="turn_bold">{{variable.label}} : </span>
                <div ng-repeat="table_variables in variable.table_variable">
                  <div ng-repeat="table_variable in table_variables track by $index">
                    <span class="turn_bold teste">{{table_variable.label}} : </span><span>{{table_variable.display_value}}</span>
                  </div>
                  <br ng-if="($index + 1) < variable.table_variable.length">
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg_content_feedback" id="conversationModalBG" ng-if="c.conversation_open" ng-click="c.hideConversation()"></div>

  <div class="content_feedback_" ng-if="c.conversation_open" tabindex="-1" role="dialog" aria-labelledby="articleModalLabel" aria-hidden="true">
    <div class="content_feedback" role="document">
      <div>
        <div>

          <button class="close close_feedback" type="button" ng-click="c.hideConversation()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div class="wrapper-xl wrapper-sc-cat-item">
            <div class="panel-body">
              <div class="activity_content">
                <ul role="list" class="timeline" aria-label="${Ticket history}">
                  <li id="comment_{{e.id}}" class="conversation_entries conversation_dynamic" ng-if="data.mergedEntries.length > 0" ng-repeat="e in data.mergedEntriesAll">
                    <div class="conversation_mark"></div>
                    <div ng-style="{'border-color': getFieldColor(e.element)}">
                      <div class="conversation_action">{{e.name}}</div>
                      <div class="conversation_description">{{e.field_label}}</div>
                      <div class="">
                        <div class="conversation_description" ng-if="(e.element != 'attachment') && (!e.showingAll && e.showAll)" ng-bind-html="e.display_value"><span ng-if="!e.showingAll">...</span></div>
                        <div class="conversation_description" ng-if="(e.element != 'attachment') && (e.showingAll || !e.showAll)" ng-bind-html="e.value"></div>
                        <div ng-if="(e.element == 'attachment')">
                          <a ng-if="(e.attachment.state == 'available')" target="_blank" href="/sys_attachment.do?view=true&sys_id={{e.attachment.sys_id}}" title="${View}">
                            <img ng-if="e.attachment.thumbnail_path" alt="" ng-src="/{{e.attachment.path}}?t=medium" class="img-responsive"/>
                          </a>
                          <a ng-if="(e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally')" ng-click="scanAttachment(e.attachment)" href="javascript:void(0)" title="${View}">
                            <img ng-if="e.attachment.thumbnail_path" alt="" ng-src="/{{::e.attachment.path}}?t=medium" class="img-responsive"/>
                          </a>
                          <div>
                            <div ng-if="(e.attachment.state == 'available')">
                              <a href="/sys_attachment.do?sys_id={{e.attachment.sys_id}}" target="_blank" title="{{dataViewMsg}}"><strong>{{e.attachment.file_name}}</strong></a><br/>
                              {{e.attachment.size}}
                            </div>
                            <div ng-if="(e.attachment.state == 'not_available')">
                              <span title="{{dataViewMsg}}" class="not_available">{{e.attachment.file_name}}</span><br/>
                              <span class="error">{{data.scanFailedMsg}}</span>
                            </div>
                            <div ng-if="(e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally')">
                              <a href="javascript:void(0)" ng-click="scanAttachment(e.attachment)" title="{{dataViewMsg}}"><strong>{{e.attachment.file_name}}</strong></a><br/>
                              {{e.attachment.size}}
                            </div>
                          </div>
                        </div>
                      </div>
                      <div ng-if="e.showTranslation" class="translation-container">
                        <div ng-if="e.isTranslationInProgress">
                          <i class="translation-icon icon-translation"></i>
                          <span aria-live="polite">{{data.translation.translationProgressMsg}}</span>
                        </div>
                        <div ng-if="e.isTranslationSuccess">
                          <i class="translation-icon icon-translation"></i>
                          <a class="translate-link" role="button" href="javascript:void(0)" ng-click="toggleTranslation(e)">{{e.toggleMsg}}</a>
                          <span class="translation-credits">{{e.credits}}</span>
                          <div ng-if="e.showDetails" class="translation-message" ng-bind-html="e.translatedText">
                          </div>
                        </div>
                        <div ng-if="e.isTranslationError">
                          <i class="translation-icon icon-translation"></i>
                          {{e.translatedText}}
                          <a ng-if="e.tryAgain" role="button" href="javascript:void(0)" class="translate-link" ng-click="translateText(e, true)">{{data.translation.tryAgainMsg}}</a>
                        </div>
                      </div>
                    </div>
                    <div ng-if="!e.showingAll && e.showAll" ng-click="c.showAllModal(e)" class="view_more_color">{{data.showAll}}</div>
                    <div class="conversation_date">{{e.createdDate}}		{{e.createdTime}}</div>
                  </li>
                  <li class="conversation_entries conversation_fixed" role="listitem" aria-label="{{data.stream.user_full_name}}">
                    <div class="conversation_mark"></div><span class="hide_timeline_property"></span><span class="new_radio_mark"></span>
                    <div class="conversation_fixed_text">
                      <div>
                        <div class="simple_conversation_title">${Abertura da Solicitação}</div>
                      </div>
                      <div class="conversation_date">{{data.createdDate}}		{{data.createdTime}}</div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade modal_article" id="openKbModal" tabindex="-1" role="dialog" aria-labelledby="articleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div>
          <sp-widget widget="data.articleWidget"></sp-widget>
        </div>
        <div class="modal-footer">
          <sp-widget widget="data.helpfulWidget"></sp-widget>
        </div>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
