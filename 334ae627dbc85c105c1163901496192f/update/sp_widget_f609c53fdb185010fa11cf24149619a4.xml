<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $rootScope, $timeout, $window) {
	/* widget controller */
	var c = this;
	c.title = "";
	c.categoryColor = "";
	c.bdColor = "";

	$scope.$on(c.data.broadcast_name, function (event, data, searchSourceID, categorySearch) {
		c.data.hasResults = false;
		if(categorySearch){
			c.data.searchSources = data.results[0].items;
			c.showArticles = true;
			for(var i in c.data.searchSources){
				if(c.data.searchSources[i].results.length > 0){
					c.data.hasResults = true;
				}
				c.data.searchSources[i].resultLimit = 2;
				if(c.data.searchSources[i].results.length > c.data.searchSources[i].resultLimit){
					c.data.searchSources[i].seeAllMsg = c.data.msgs.seeAll;
				}else{
					c.data.searchSources[i].seeAllMsg = c.data.msgs.seeLess;
				}
			}
			c.data.searchMade = true;
		}
		else{
			c.data.action = "searchedItem";
			c.data.searchSourceID = searchSourceID;
			c.data.searchResult = data;
			c.server.update().then(function() {
				c.showArticles = c.data.showArticles;
				for(var i in c.data.searchSources){
					if(c.data.searchSources[i].results.length > 0){
						c.data.hasResults = true;
					}
					for(var j in c.data.searchSources[i].results){
						c.data.searchSources[i].results[j].title = replaceHtml(c.data.searchSources[i].results[j].title);
					}
				}
				c.data.searchMade = true;
			});
		}
	});

	$scope.$on((c.data.broadcast_name + "Title"), function (event, categoryTitle, categoryColor) {
		c.title = categoryTitle;
		c.categoryColor = categoryColor;
		c.bdColor = "bd" + categoryColor;

	});

	$scope.$on(c.data.broadcast_name + "Clear", function (event) {
		c.data.searchSources = [];
		c.data.searchMade = false;
		c.data.hasResults = false;
	});

	//When an article searched by the "GService Typeahead Search" widget is clicked, we send the data to the widget embedded
	//in this widget and show this widget in a modal.
	c.showResult = function(resultID, table, taskType, csc_question){
		if(table == "kb_knowledge"){
			var jsonArticle = {articleID : resultID, categoryTitle : c.title, categoryColor: c.categoryColor};
			var showCategory = false;
			if(c.data.broadcast_name == "getSearchedItemsCategory"){
				showCategory = true;
			}
			$rootScope.$broadcast((c.data.broadcast_name + "openArticle"), jsonArticle, showCategory);
			c.isLoading = true;
			var modalID = "#" + c.data.articleModalID;
			$(modalID).modal("show");
		}
		else if(table == "sc_cat_item" || table == "x_gmeps_csc_link_catalog_item"){
			$rootScope.$broadcast('openSelectedCategoryItem', false, resultID);
		}
		else if(table == "task"){
			if(taskType == "x_gmeps_csc_csc" || csc_question){
				$window.location = "?id=globoservice_my_dashboard&item_id_csc=" + resultID;
			}
			else{
				$window.location = "?id=globoservice_my_dashboard&item_id=" + resultID;
			}
		}
		else if(table == "sc_category"){
			$rootScope.$broadcast('openSelectedCategoryItem', resultID, false);
		}

	}

	c.seeAll = function(searchSource){
		if(searchSource.resultLimit != null){
			searchSource.resultLimit = null;
			searchSource.seeAllMsg = c.data.msgs.seeLess;
		}
		else{
			searchSource.resultLimit = 2;
			searchSource.seeAllMsg = c.data.msgs.seeAll;
		}


	}

	function replaceHtml(string) {
		return string.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"');
	}

}]]></client_script>
        <controller_as>c</controller_as>
        <css>.articles {
  display: flex;
  flex-direction: column;
  padding: 20px;

  .article {
    color: $slate-gray;

    .article_title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      span { font-weight: normal; }
    }
    .article_list {
      font-size: 14px;
      margin-top: 5px;
      text-decoration: underline;

      &amp;:hover {
        font-weight: bold;
      }
    }
    .article_all {
      transition: .4s ease-in-out;
      font-weight: bold;
      text-decoration: underline;
      margin-top: 10px;

      &amp;:hover {
        opacity: .7;
        transition: .2s ease-in-out;
      }
    }
    .article_line {
      height: 1px;
      margin: 20px 0;
      background-color: $slate-gray;;
    }
  }
}

.modal_article {
  color: $slate-gray;

  .modal-body {
    .article_widget {
      padding: 0 50px;
    }
  }
  .modal-footer {
    margin: 0 50px;
    border-top: 2px solid $dodger-blue;

    .help_like, .help_dislike {
      transition: .4s ease-in-out;
      &amp;:hover {
        transition: .2s ease-in-out;
        transform: scale(1.1);
        -webkit-transform: scale(1.1);
        -ms-transform: scale(1.1);
        -moz-transform: scale(1.1);
        -o-transform: scale(1.1);
      }
    }
  }
}

.no_results {
  font-size: 18px;
  margin-top: 20px;
  margin-bottom: 40px;
  text-align: center;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>gservice_search_result</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>GService Search Result</name>
        <option_schema>[{"name":"broadcast_name","section":"Behavior","label":"Broadcast Name","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */
	var localInput = input;
	var portalUtils = new global.OCLPortalUtils();
	data.hasResults = false;
	data.searchMade = false;
	data.broadcast_name = options.broadcast_name;
	data.articleModalID = data.broadcast_name + "ArticleModal";
	data.msgs = {};
	data.msgs.seeAll = gs.getMessage("See all").toLowerCase();
	data.msgs.seeLess = gs.getMessage("See less").toLowerCase();
	data.article_widget_options = {"broadcast_name": (data.broadcast_name + "openArticle")};
	data.articleWidget = $sp.getWidget("gservice_knowledge_article_content", data.article_widget_options);
	data.helpfulWidget = $sp.getWidget("gservice_knowledge_article_helpful_v2");

	if(localInput){
		if(localInput.action == "searchedItem"){
			data.broadcast_name = localInput.broadcast_name;
			data.searchSources = portalUtils.setSearchSources(localInput.searchSourceID, data.msgs.seeAll);

			var searchResults = localInput.searchResult;

			if(searchResults.results.length > 0){
				data.showArticles = true;
				var results = searchResults.results;
				for(i in results){
					var taskType = "";
					var csc_question = false;
					if(results[i].table == "task"){
						taskType = results[i].fields[1].value;
						var grQuestion = new GlideRecord("u_question");
						if(grQuestion.get(results[i].sys_id)){
							if(grQuestion.getValue("u_area") == "financas"){
								csc_question = true;
							}
						}
					}
					
					var jsonArticle = {"title": results[i].primary, 
														 "id": results[i].sys_id,
														 "description" : results[i].fields[0].display_value,
														 "taskType" : taskType,
														 "table" : results[i].table,
														 "csc_question" : csc_question};
					if(jsonArticle.description == '(empty)'){
						jsonArticle.description = '';
					}
					var searchID = results[i].__search_source_id__;
					for(var j in data.searchSources){
						if(data.searchSources[j].id == searchID){
							data.searchSources[j].results.push(jsonArticle);
						}
					}
				}
			}
			else{
				data.showArticles = false;
			}
		}
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>organize.fernando</sys_created_by>
        <sys_created_on>2020-04-27 14:21:58</sys_created_on>
        <sys_id>f609c53fdb185010fa11cf24149619a4</sys_id>
        <sys_mod_count>319</sys_mod_count>
        <sys_name>GService Search Result</sys_name>
        <sys_package display_value="ITSM Service Portal" source="x_gmeps_itsm_servi">334ae627dbc85c105c1163901496192f</sys_package>
        <sys_policy/>
        <sys_scope display_value="ITSM Service Portal">334ae627dbc85c105c1163901496192f</sys_scope>
        <sys_update_name>sp_widget_f609c53fdb185010fa11cf24149619a4</sys_update_name>
        <sys_updated_by>organize.fernando</sys_updated_by>
        <sys_updated_on>2020-09-24 14:01:52</sys_updated_on>
        <template><![CDATA[<div class="col-lg-12 col-md-12 col-sm-12" ng-if="data.hasResults">
  <div class="articles">
    <div class="article" ng-if="c.showArticles" ng-repeat="searchSource in data.searchSources">
      <div ng-if="searchSource.results.length > 0">
        <div class="article_title">{{searchSource.name}} <span>({{searchSource.results.length}})</span></div>
        <div  ng-repeat="results in searchSource.results | limitTo: searchSource.resultLimit">
          <div class="article_list" ng-click="c.showResult(results.id, results.table, results.taskType, results.csc_question)">{{results.title}}</div>
          <div>{{results.description}}</div>
        </div>
        <div class="article_all" ng-if="searchSource.results.length > 2" ng-click="c.seeAll(searchSource)">{{searchSource.seeAllMsg}}</div>
        <div class="article_line"></div>
      </div>
    </div>
  </div>
</div>
<div ng-if="!data.hasResults && data.searchMade">
  <div class="no_results">
    ${Ops, não encontramos o que você está buscando.}
  </div>
</div>
<div class="modal fade modal_article" id="{{data.articleModalID}}" tabindex="-1" role="dialog" aria-labelledby="articleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="article_widget">
          <sp-widget widget="data.articleWidget"></sp-widget>
        </div>
      </div>
      <div class="modal-footer {{c.bdColor}}">
        <sp-widget widget="data.helpfulWidget"></sp-widget>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
